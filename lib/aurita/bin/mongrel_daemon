#!/usr/bin/env ruby

require 'rubygems'
require 'logger'
require 'aurita'

require 'mongrel'
require 'yaml'
require 'zlib'

project_name = ARGV[0]
port         = ARGV[1]
port       ||= 3000
port         = port.to_i
gatling      = ARGV[2] == 'gatling'
short        = ARGV[2] == 'short'

if !project_name then
  puts "Usage: "
  puts ""
  puts "  daemon <project_name> <port> [mode]"
  puts ""
  puts "Following optional modes are supported: "
  puts "  gatling - Serve (short) requests, without session handling"
  puts "  short   - Serve short requests with session handling"
  puts ""
  exit
end

logfile = "/var/log/aurita/aurita_#{project_name}_debug.log"

Aurita.load_project project_name.to_sym

Lore.enable_logging
Lore.enable_query_log
Lore.logfile                       = logfile
Lore.query_logfile                 = logfile
Lore.logger.level                  = Logger::DEBUG
Lore.query_logger.level            = Logger::DEBUG
Aurita::Configuration.sys_log_path = logfile
Aurita::Configuration.run_log_path = logfile

Aurita.bootstrap

Aurita.import :handler, :mongrel_daemon

OPTIONS = {
  :port            => port,
  :ip              => "0.0.0.0",
  :server_root     => Aurita.project.base_path + '/public/', 
  :compress        => true, 
  :chunked         => true
}
# Gatling mode is as fast as can be, but without 
# sessions, e.g. only public services are available. 
if gatling then
  OPTIONS[:chunked]     = false
  OPTIONS[:no_sessions] = true
# Short mode is for requests that need session 
# handling ( => user identification) but will 
# return short responses. 
elsif short then
  OPTIONS[:chunked]     = false
  OPTIONS[:no_sessions] = false
end

web_server = Aurita::Mongrel_Daemon.new(OPTIONS)
daemon_logger = ::Logger.new(logfile)
daemon_logger.progname = "(Port #{port})"
web_server.logger = daemon_logger
web_server.run

